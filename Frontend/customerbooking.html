<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Customer Bookings - Mensa Power Controls</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f5f7fa;
        margin: 0;
      }

      .top-nav {
        background: #000;
        color: #fff;
        padding: 10px 15px;
        display: flex;
        align-items: center;
      }

      @media (max-width: 768px) {
        .top-nav {
          background: #1f2937; /* dark gray */
        }
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
      }

      .brand img {
        height: 40px;
      }

      .nav-right {
        margin-left: auto;
        display: flex;
        gap: 15px;
      }

      .nav-right a {
        color: #fff;
        text-decoration: none;
        padding: 8px 18px;
        border-radius: 20px;
      }

      .nav-right a.active {
        background: #444;
      }

      .table thead {
        background-color: #212529;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="top-nav">
      <div class="brand">
        <img src="assets/images/blacklogo.png" alt="Logo" />
        MENSA POWER CONTROLS
      </div>

      <div class="nav-right">
        <a href="customerbooking.html" class="active">Customer Bookings</a>
        <a href="billinginvoice.html">Billing & Invoice</a>
      </div>
    </div>

    <div class="container mt-4">
      <h3>Customer Bookings</h3>

      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>Customer Name</th>
              <th>Company Name</th>
              <th>Email</th>
              <th>Phone No</th>
              <th>Booking Date</th>
              <th>Service Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="bookingTable"></tbody>
        </table>
      </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal fade" id="editModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Edit Booking</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="editId" />

            <input
              class="form-control mb-2"
              id="editCustomer"
              placeholder="Customer Name"
            />
            <input
              class="form-control mb-2"
              id="editCompany"
              placeholder="Company Name"
            />
            <input
              class="form-control mb-2"
              id="editEmail"
              placeholder="Email"
            />
            <input
              class="form-control mb-2"
              id="editMobile"
              placeholder="Mobile"
            />
          </div>

          <div class="modal-footer">
            <button class="btn btn-success" onclick="saveEdit()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      
      let ids;
      async function loadBookings() {
        const res = await fetch("http://localhost:5000/all-bookings");
        const bookings = await res.json();
        console.log(bookings)
        ids = bookings[0]._id
        console.log(ids)
        const table = document.getElementById("bookingTable");
        table.innerHTML = "";

        bookings.forEach((b) => {
          table.innerHTML += `
      <tr>
        <td>${b.customerName}</td>
        <td>${b.companyName}</td>
        <td>${b.email}</td>
        <td>${b.mobile}</td>
        <td>${new Date(b.createdAt).toLocaleDateString()}</td>
        <td>
          <button class="btn btn-sm ${b.serviceStatus === "Complete" ? "btn-success" : "btn-warning"}"
            onclick="toggleStatus('${b._id}','${b.serviceStatus}')">
            ${b.serviceStatus}
          </button>
        </td>
        <td>
          <button class="btn btn-success btn-sm"
  onclick="openEditModal(
    '${b._id}',
    '${b.customerName}',
    '${b.companyName}',
    '${b.email}',
    '${b.mobile}'
  )">
  Edit
</button>

          <button class="btn btn-sm btn-danger" onclick="deleteBooking('${b._id}')">Delete</button>
        </td>
      </tr>`;
        });
      }

      async function toggleStatus(id, current) {
        const status = current === "Complete" ? "Incomplete" : "Complete";
        await fetch(`http://localhost:5000/booking-status/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status }),
        });
        loadBookings();
      }

      async function deleteBooking(id) {
        await fetch(`http://localhost:5000/booking/${id}`, {
          method: "DELETE",
        });
        loadBookings();
      }

      loadBookings();

      function openEditModal(id, customer, company, email, mobile) {
  document.getElementById("editId").value = id;
  document.getElementById("editCustomer").value = customer;
  document.getElementById("editCompany").value = company;
  document.getElementById("editEmail").value = email;
  document.getElementById("editMobile").value = mobile;

  const modal = new bootstrap.Modal(document.getElementById("editModal"));
  modal.show();
}

async function saveEdit() {
  const id = document.getElementById("editId").value;

  const payload = {
    customerName: document.getElementById("editCustomer").value,
    companyName: document.getElementById("editCompany").value,
    email: document.getElementById("editEmail").value,
    mobile: document.getElementById("editMobile").value
  };

  try {
    const res = await fetch(`http://localhost:5000/booking/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // ✅ READ RAW RESPONSE FIRST
    const text = await res.text();

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("Server returned non-JSON:", text);
      alert("Server error (invalid response)");
      return;
    }

    if (!res.ok) {
      alert(data.message || "Update failed");
      return;
    }

    // ✅ SUCCESS
    alert("Booking updated successfully");
    bootstrap.Modal.getInstance(
      document.getElementById("editModal")
    ).hide();

    loadBookings();
  } catch (err) {
    console.error(err);
    alert("Server error");
  }
}

</script>
</body>
</html>
