<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mensa Power Controls | Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  min-height:100vh;
  background:
    radial-gradient(circle at top left, rgba(0,140,255,.25), transparent 40%),
    radial-gradient(circle at bottom right, rgba(0,255,200,.2), transparent 40%),
    linear-gradient(120deg, #050505, #0b1a2a, #000);
  background-attachment: fixed;
}

.navbar { background:#000; }
.navbar-brand {
  color:#fff !important;
  display:flex;
  align-items:center;
  gap:10px;
}
.navbar-brand img { height:36px; }
.nav-link {
  color:#fff !important;
  padding:6px 14px;
  border-radius:4px;
}
.nav-link.active { background:#444; }
.nav-link:hover { background:#333; }

.login-wrapper {
  min-height:calc(100vh - 70px);
  display:flex;
  align-items:center;
  justify-content:center;
}

.login-box {
  width:100%;
  max-width:400px;
  background:rgba(230,230,230,0.95);
  padding:32px;
  border-radius:10px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  text-align:center;
}

.password-toggle {
  cursor:pointer;
  font-size:14px;
  color:#000;
}

@media (max-width:576px) {
  .login-box { padding:26px 22px; }
}
</style>
</head>

<body>

<nav class="navbar navbar-expand-lg px-3">
  <a class="navbar-brand fw-bold" href="index.html">
    <img src="assets/images/blacklogo.png" alt="Mensa Logo">
    MENSA POWER CONTROLS
  </a>

  <button class="navbar-toggler bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navMenu">
    <ul class="navbar-nav ms-auto text-center">
      <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
      <li class="nav-item"><a class="nav-link active" href="login.html">Login</a></li>
      <li class="nav-item"><a class="nav-link" href="signup.html">Signup</a></li>
      <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
    </ul>
  </div>
</nav>

<div class="login-wrapper">
  <div class="login-box">
    <h4 class="mb-4">Login</h4>

    <form id="loginForm">
      <input type="email" id="loginEmail" class="form-control mb-3" placeholder="Email" required>
      <input type="password" id="loginPassword" class="form-control mb-2" placeholder="Password" required>

      <span class="password-toggle" onclick="togglePassword('loginPassword', this)">
        Show Password
      </span>

      <button type="submit" class="btn btn-dark w-100 mt-3">Submit</button>
    </form>

    <p class="mt-3">
      Don’t have an account?
      <a href="signup.html" class="text-dark fw-semibold text-decoration-none">Signup</a>
    </p>

    <p class="mt-2">
      <a href="#" onclick="forgotPassword()" class="text-dark fw-semibold text-decoration-none">
        Forgot password?
      </a>
    </p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
 function togglePassword(id, el) {
  const input = document.getElementById(id);
  if (input.type === "password") {
    input.type = "text";
    el.innerText = "Hide Password";
  } else {
    input.type = "password";
    el.innerText = "Show Password";
  }
}

const BACKEND_URL = 'http://localhost:5000';

/* ✅ REAL FORGOT PASSWORD (CONNECTED TO BACKEND) */
async function forgotPassword() {
  const email = prompt("Enter your registered email:");
  if (!email) return;

  const newPassword = prompt("Enter new password:");
  if (!newPassword) return;

  const confirmPassword = prompt("Re-enter new password:");
  if (!confirmPassword) return;

  if (newPassword !== confirmPassword) {
    alert("Passwords do not match");
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/forgot-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, newPassword })
    });

    const data = await res.json();

    if (res.ok) {
      alert("Password reset successful. Please login with your new password.");
    } else {
      alert(data.message || "Password reset failed");
    }
  } catch (err) {
    alert("Server error. Try again.");
  }
}

/* ✅ LOGIN HANDLER (FIXED & WORKING) */
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;

  try {
    const res = await fetch(`${BACKEND_URL}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (res.ok && data.token) {

      /* ✅ SAVE TOKEN */
      localStorage.setItem('token', data.token);
      console.log("TOKEN SAVED:", localStorage.getItem("token"));

      /* ✅ RESUME SERVICE FLOW IF USER CAME FROM SERVICES */
      const pendingService = localStorage.getItem("pendingService");

      if (pendingService) {
  window.location.href = "index.html";
} else {
  window.location.href = "index.html";
}

} else {
      alert("❌ Invalid email or password");
    }

  } catch (err) {
    alert("Server error. Try again.");
  }
});
</script>
</body>
</html>
